<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZ Trip Planner (Offline, iPad Drag/Drop, Rated Options, Date-aware)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7f9; color:#111; }
    header { padding: 16px 18px; background:#0b2a4a; color:#fff; }
    header h1 { margin:0 0 6px 0; font-size: 18px; }
    header p { margin:0; opacity:.9; font-size: 13px; }

    .wrap { padding: 14px 18px 30px; max-width: 1500px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns: 480px 1fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card { background:#fff; border-radius: 12px; box-shadow: 0 1px 10px rgba(0,0,0,.06); padding: 12px; }
    .card h2 { margin: 6px 0 10px; font-size: 15px; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: end; }
    label { font-size: 12px; color:#333; display:block; margin: 10px 0 4px; }
    input, select, button, textarea {
      font: inherit; font-size: 13px;
      border: 1px solid #d7dbe2; border-radius: 10px;
      padding: 9px 10px; background:#fff;
    }
    input[type="number"] { width: 130px; }
    input[type="date"], input[type="time"] { width: 160px; }
    select { min-width: 200px; }
    textarea { width: 100%; min-height: 64px; resize: vertical; }
    button { cursor:pointer; border:none; background:#0b2a4a; color:#fff; padding: 10px 12px; border-radius: 10px; }
    button.secondary { background:#e9edf3; color:#111; border: 1px solid #d7dbe2; }
    button.danger { background:#b42318; }
    .muted { color:#556; font-size: 12px; line-height: 1.35; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px 8px; border-bottom: 1px solid #eef1f6; font-size: 13px; vertical-align: top; }
    th { font-size: 12px; color:#445; text-transform: uppercase; letter-spacing: .04em; }

    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #d7dbe2; background:#f7f9fc; margin-right: 6px; margin-top: 6px; }
    .pill.low { border-color:#b7e0c2; background:#effbf2; }
    .pill.med { border-color:#ffe2a8; background:#fff8ea; }
    .pill.high { border-color:#ffc2c2; background:#fff2f2; }
    .pill.warn { border-color:#ffb4b4; background:#ffecec; }
    .pill.flight { border-color:#c6d4ff; background:#eef2ff; }
    .pill.tag { border-color:#d7dbe2; background:#f7f9fc; }
    .pill.star { border-color:#cbd5e1; background:#f8fafc; }
    .pill.free { border-color:#c7f9d2; background:#edfff1; }

    a { color:#0b2a4a; }
    .right { text-align:right; }

    .notice { background:#0b2a4a0d; border:1px solid #0b2a4a22; border-radius: 12px; padding: 10px; margin-top: 10px; }
    .dayHeader { margin-top: 14px; padding: 10px; border-radius: 12px; background: #f2f5fb; border: 1px solid #e5eaf5; }

    /* Touch drag */
    .dragHandle {
      touch-action: none;
      cursor: grab;
      font-size: 16px;
      line-height: 1;
      padding: 6px 8px;
      border: 1px solid #d7dbe2;
      border-radius: 10px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    tr.dragging { opacity: .55; }
    tr.dropTarget { outline: 2px dashed #0b2a4a; outline-offset: -4px; }
  
    /* Responsive improvements */
    .desktopOnly { display: block; }
    .mobileOnly { display: none; }

    .actionBar {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      position: sticky; top: 0;
      background: #fff;
      padding: 10px 0 10px 0;
      z-index: 5;
      border-bottom: 1px solid #eef1f6;
      margin-bottom: 6px;
    }
    .actionBar .row { margin: 0; }
    .actionBar .hint { font-size:12px; color:#556; }

    .itCard {
      border: 1px solid #eef1f6;
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0;
      background: #fff;
    }
    .itCardHeader {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .itCardTitle { font-weight: 650; }
    .itCardMeta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .itCardGrid { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .itCardGrid .field label { margin:0 0 4px; }
    .itCardGrid .field input, .itCardGrid .field select { width: 100%; min-width: 0; }
    .itCardNotes { margin-top: 8px; }
    .itCardNotes input { width:100%; }

    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
      .wrap { padding: 12px 12px 24px; }
      header { padding: 14px 12px; }
      .card { padding: 12px; }
    }

    @media (max-width: 720px){
      /* Phone: show cards instead of table */
      .desktopOnly { display: none; }
      .mobileOnly { display: block; }
      table { display:none; }
      input[type="date"], input[type="time"] { width: 100%; }
      input[type="number"] { width: 100%; }
      select { width: 100%; min-width: 0; }
      .row { gap: 10px; }
      .dayHeader { margin-top: 10px; }
      .notice { margin-top: 10px; }
    }

  </style>
</head>
<body>
<header>
  <h1>NZ Trip Planner — Offline (iPad drag/drop + selectable + rated)</h1>
  <p>January-friendly options added. Date changes move items into the right day and reflow times.</p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>Budget, Filters & Time Rules</h2>

      <div class="row">
        <div>
          <label>Budget mode</label>
          <select id="budgetMode">
            <option value="day" selected>Daily (recommended)</option>
            <option value="week">Weekly</option>
            <option value="total">Total trip</option>
          </select>
        </div>

        <div>
          <label>Budget / day (NZD)</label>
          <input id="budDay" type="number" min="0" step="10" value="180" />
        </div>

        <div>
          <label>Budget / week (NZD)</label>
          <input id="budWeek" type="number" min="0" step="50" value="900" />
        </div>

        <div>
          <label>Budget / total (NZD)</label>
          <input id="budTotal" type="number" min="0" step="100" value="3600" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Walking tolerance</label>
          <select id="walkFilter">
            <option value="any">Any</option>
            <option value="low">Low only</option>
            <option value="med" selected>Low + Medium</option>
          </select>
        </div>

        <div>
          <label>Region filter</label>
          <select id="regionFilter">
            <option value="All" selected>All regions</option>
            <option value="Auckland base">Auckland base</option>
            <option value="Hauraki Gulf islands">Hauraki Gulf islands</option>
            <option value="Bay of Islands">Bay of Islands</option>
            <option value="North Island trip">North Island trip</option>
            <option value="Coromandel (trip)">Coromandel (trip)</option>
            <option value="Waikato (day trip)">Waikato (day trip)</option>
            <option value="Central Plateau (Taupo)">Central Plateau (Taupo)</option>
            <option value="South Island (flight)">South Island (flight)</option>
            <option value="Sports & venues">Sports & venues</option>
            <option value="Free / low-cost">Free / low-cost</option>
          </select>
        </div>

        <div>
          <label>Show only highly-rated</label>
          <select id="ratingFilter">
            <option value="off" selected>Off</option>
            <option value="46">≥ 4.6</option>
            <option value="48">≥ 4.8</option>
          </select>
        </div>
      </div>

      <h2 style="margin-top:14px;">Auto time settings</h2>
      <div class="row">
        <div>
          <label>Day start time</label>
          <input id="dayStart" type="time" value="10:00"/>
        </div>
        <div>
          <label>Slot duration (mins)</label>
          <input id="slotMins" type="number" min="30" step="15" value="120"/>
        </div>
        <div>
          <label>Break (mins)</label>
          <input id="breakMins" type="number" min="0" step="5" value="45"/>
        </div>
      </div>

      <div class="notice">
        <div class="muted">
          <strong>iPad drag/drop:</strong> Drag using the ⠿ handle. After drop (or date change), times reflow for impacted date(s).<br/>
          <strong>January note:</strong> Peak season — book ferries/tours early, plan heat breaks, and prefer seated/water-based options midday.
        </div>
      </div>

      <label>Quick links</label>
      <ul class="muted">
        <li><a href="https://at.govt.nz/bus-train-ferry/journey-planner" target="_blank" rel="noreferrer">AT Journey Planner (Auckland)</a></li>
        <li><a href="https://www.intercity.co.nz/" target="_blank" rel="noreferrer">InterCity (coach)</a></li>
        <li><a href="https://www.fullers.co.nz/timetables-and-fares/" target="_blank" rel="noreferrer">Fullers360 ferries (Auckland)</a></li>
        <li><a href="https://edenpark.co.nz/events/" target="_blank" rel="noreferrer">Eden Park events calendar</a></li>
      </ul>

      <div class="row" style="margin-top:10px;">
        <button id="exportJson" class="secondary">Export plan (JSON)</button>
        <button id="importJson" class="secondary">Import plan (JSON)</button>
        <button id="resetFilters" class="secondary">Reset filters</button>
        <button id="reset" class="secondary">Reset</button>
      </div>

      <div id="io" style="display:none; margin-top:10px;">
        <label>Plan JSON (copy/paste)</label>
        <textarea id="ioText"></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="ioClose" class="secondary">Close</button>
          <button id="ioApply">Apply import</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>Itinerary</h2>

      <div class="actionBar">
        <div class="row">
          <button id="addSuggested">+ Add from options</button>
        <button id="addBuffer" class="secondary">+ Add “Rest / Buffer”</button>
        <button id="reflowAll" class="secondary">Reflow times</button>
        </div>
        <div class="hint">Tip: On phone, the itinerary shows as editable cards.</div>
      </div>

      <p class="muted" id="summary" style="margin-top:10px;"></p>

      <div style="overflow:auto; margin-top:8px;">
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:52px;">Move</th>
              <th style="min-width:115px;">Date</th>
              <th style="min-width:95px;">Time</th>
              <th style="min-width:420px;">Activity</th>
              <th style="min-width:200px;">Region</th>
              <th style="min-width:90px;">Walk</th>
              <th style="min-width:110px;">Est. cost</th>
              <th style="min-width:320px;">Transport / Rating</th>
              <th class="right" style="min-width:90px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="itineraryCards" class="mobileOnly"></div>

      <h2 style="margin-top:16px;">Options (selectable)</h2>
      <p class="muted">Filter by region/walking/rating on the left. Add, then drag to schedule. Ratings link out to review pages where available.</p>
      <div id="suggestions"></div>
    </div>
  </div>
</div>

<script>
  // ---------- Links ----------
  const LINKS = {
    atPlanner: { label: "AT Journey Planner", url: "https://at.govt.nz/bus-train-ferry/journey-planner" },
    intercity: { label: "InterCity", url: "https://www.intercity.co.nz/" },
    fullers: { label: "Fullers360 ferries", url: "https://www.fullers.co.nz/timetables-and-fares/" },
    boiFerry: { label: "Bay of Islands ferries (Paihia ⇄ Russell)", url: "https://northlandferries.co.nz/bay-of-islands-ferry/" },
    edenEvents: { label: "Eden Park events", url: "https://edenpark.co.nz/events/" },
    edenTour: { label: "Eden Park stadium tour", url: "https://edenpark.co.nz/experiences/stadium-tour/" },
    edenRooftop: { label: "Eden Park rooftop walk", url: "https://edenpark.co.nz/experiences/rooftop-walk/" },
    auckStadiumsAFC: { label: "Auckland FC (home season listings)", url: "https://www.aucklandstadiums.co.nz/event/auckland-fc-20252026-home-a-league-season" },
    auckAFCMatches: { label: "Auckland FC matches", url: "https://aucklandfc.co.nz/matches/" },
    airnz: { label: "Air NZ flights", url: "https://www.airnewzealand.co.nz/" },
    hobbiton: { label: "Hobbiton info", url: "https://www.hobbitontours.com/" }
  };

  // ---------- Activities ----------
  // rating: out of 5 (optional), ratingCount: optional, ratingUrl: optional
  // free: boolean -> shown as "Free/low-cost"
  const ACTIVITIES = [
    // ----------------------------
    // Free / low-cost Auckland
    // ----------------------------
    { id:"free-mt-eden", title:"Mount Eden / Maungawhau drive-up viewpoint (short walk only)", region:"Free / low-cost", walk:"low", cost:0, free:true,
      tags:["views","sunset"], transport:[LINKS.atPlanner],
      notes:"Great January option. Keep walking minimal; check current summit/road access before you go." },

    { id:"free-mission-bay", title:"Mission Bay: beach + cafés (seated, flat, easy)", region:"Free / low-cost", walk:"low", cost:0, free:true,
      tags:["beach","easy"], transport:[LINKS.atPlanner],
      notes:"Perfect ‘recovery’ day in January. Go early or late to avoid heat." },

    { id:"free-waitakere-lookouts", title:"West Auckland scenic lookouts (drive-up viewpoints; minimal walking)", region:"Free / low-cost", walk:"low", cost:0, free:true,
      tags:["scenic","photo"], transport:[LINKS.atPlanner],
      notes:"Best with weekend vehicle. Choose lookouts with short paths only." },

    // ----------------------------
    // Auckland base (paid but low walking)
    // ----------------------------
    { id:"auck-waterfront", title:"Auckland waterfront sit-down day (Viaduct/Wynyard Quarter cafés)", region:"Auckland base", walk:"low", cost:25,
      tags:["easy","heat-friendly"], transport:[LINKS.atPlanner], notes:"Shade + seating + short distances." },

    { id:"auck-museum", title:"Auckland Museum (benches + slow pace)", region:"Auckland base", walk:"low", cost:35,
      tags:["indoor","restful"], transport:[LINKS.atPlanner], notes:"Pick 2–3 areas only, then leave." },

    { id:"auck-harbour-cruise", title:"Auckland Harbour Cruise (seated sightseeing)", region:"Auckland base", walk:"low", cost:80,
      tags:["seated","water"], transport:[LINKS.atPlanner],
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255106-d11453559-Auckland_Harbour_Cruise-Auckland_Central_North_Island.html",
      notes:"Excellent knee-friendly ‘big view’ activity." },

    { id:"auck-eco-safari", title:"Auckland Dolphin & Whale Eco-Safari Cruise", region:"Auckland base", walk:"low", cost:219,
      tags:["seated","wildlife"], transport:[LINKS.atPlanner],
      rating:4.6, ratingCount:1422,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255106-d11454305-Auckland_Dolphin_and_Whale_Watching_Eco_Safari_Cruise-Auckland_Central_North_Islan.html",
      notes:"High-impact/low-walking. Sea conditions vary; bring layers." },

    // Auckland fishing
    { id:"fish-auck-megabites", title:"Auckland fishing charter: Megabites Fishing Charter (snapper etc.)", region:"Auckland base", walk:"low", cost:230,
      tags:["fishing","half-day"], transport:[LINKS.atPlanner],
      ratingUrl:"https://www.tripadvisor.co.nz/Attraction_Review-g255106-d3494058-Reviews-Megabites_Fishing_Charter_Ltd-Auckland_Central_North_Island.html",
      notes:"Best for a seated/boat day. Confirm accessibility and toilet facilities on board." },

    { id:"fish-auck-ultimate", title:"Auckland fishing charter: Ultimate Charters (groups / catered options)", region:"Auckland base", walk:"low", cost:260,
      tags:["fishing","group"], transport:[LINKS.atPlanner],
      ratingUrl:"https://www.tripadvisor.co.nz/Attraction_Review-g1811027-d4214127-Reviews-Ultimate_Charters-Auckland_North_Island.html",
      notes:"Good choice for a social day out with minimal walking." },

    // ----------------------------
    // Hauraki Gulf islands
    // ----------------------------
    { id:"hg-devonport", title:"Devonport ferry + lunch (short distances, lots of seating)", region:"Hauraki Gulf islands", walk:"low", cost:35,
      tags:["ferry","easy"], transport:[LINKS.fullers, LINKS.atPlanner], notes:"2–3 hours max is ideal." },

    { id:"hg-waiheke-premium", title:"Waiheke: premium wine tour (transport included)", region:"Hauraki Gulf islands", walk:"low", cost:220,
      tags:["scenic","food/wine"], transport:[LINKS.fullers],
      rating:4.8, ratingCount:446,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g285729-d11466288-Waiheke_Island_Premium_Wine_Tour_with_Tastings-Waiheke_Island_North_Island.html",
      notes:"Choose a tour with transport included to minimise walking." },

    { id:"hg-tiritiri", title:"Tiritiri Matangi: day trip (shortest loop + many breaks)", region:"Hauraki Gulf islands", walk:"med", cost:160,
      tags:["wildlife","iconic"], transport:[LINKS.fullers],
      rating:4.8, ratingCount:34,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255106-d11453566-Tiritiri_Matangi_Island_Day_Trip_from_Auckland_with_Optional_Guided_Walk-Auckland_.html",
      notes:"Birdlife highlight. Keep walking light and planned." },

    { id:"hg-rotoroa", title:"Rotoroa Island: ferry day trip (quiet island, pick flat areas)", region:"Hauraki Gulf islands", walk:"med", cost:110,
      tags:["quiet","wildlife"], transport:[LINKS.fullers],
      rating:5.0, ratingCount:5,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255106-d32227728-Rotoroa_Island_Ferry_from_Auckland-Auckland_Central_North_Island.html",
      notes:"Less crowded option. Stick to accessible beaches/paths." },

    // ----------------------------
    // Bay of Islands (expanded)
    // ----------------------------
    { id:"boi-russell", title:"Paihia ⇄ Russell ferry + café (2–3 hours total)", region:"Bay of Islands", walk:"low", cost:25,
      tags:["ferry","easy"], transport:[LINKS.boiFerry],
      notes:"Great low-walking outing." },

    { id:"boi-hole-in-rock", title:"Bay of Islands: Hole in the Rock scenic cruise + island stop", region:"Bay of Islands", walk:"low", cost:190,
      tags:["iconic","boat"], transport:[LINKS.intercity],
      rating:4.6, ratingCount:114,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255110-d24142517-Hole_in_the_Rock_Scenic_Cruise_including_Dolphins_and_Island_stop-Paihia_Bay_of_Is.html",
      notes:"Mostly seated. Confirm boarding accessibility and sea conditions." },

    { id:"boi-hole-in-rock-2stop", title:"Bay of Islands: Hole in the Rock cruise + two island stopovers", region:"Bay of Islands", walk:"low", cost:170,
      tags:["boat","scenic"], transport:[LINKS.intercity],
      rating:4.9, ratingCount:441,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255110-d23822966-Hole_in_the_Rock_Cruise_Island_Stopover_Half_Day-Paihia_Bay_of_Islands_Northland_R.html",
      notes:"Choose the gentlest island stop (stay near landing area if needed)." },

    { id:"boi-cape-reinga-90mile", title:"Far North day tour: Cape Reinga + 90 Mile Beach (from Paihia)", region:"Bay of Islands", walk:"low", cost:210,
      tags:["full-day","bucket-list"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255110-d21035384-Cape_Reinga_90_Mile_Beach_Tour_With_Lunch-Paihia_Bay_of_Islands_Northland_Region_N.html",
      notes:"Long day but mostly seated. Great January weather option. Ask about sandboarding/walking and opt out if knees." },

    // Bay of Islands fishing
    { id:"fish-boi-charter-search", title:"Bay of Islands fishing charter options (browse + pick best fit)", region:"Bay of Islands", walk:"low", cost:260,
      tags:["fishing","charter"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/Attractions-g255110-Activities-c61-t217-Paihia_Bay_of_Islands_Northland_Region_North_Island.html",
      notes:"Use the linked list to choose half-day/full-day, private/shared, and accessibility." },

    // ----------------------------
    // North Island trip highlights
    // ----------------------------
    { id:"ni-hobbiton-auck", title:"Hobbiton: small-group tour from Auckland (iconic)", region:"North Island trip", walk:"med", cost:370,
      tags:["must-do","iconic"], transport:[LINKS.intercity, LINKS.hobbiton],
      rating:4.9, ratingCount:835,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255106-d13188062-Hobbiton_Movie_Set_Small_Group_Tour_from_Auckland-Auckland_Central_North_Island.html",
      notes:"Paced walking/standing. Choose coach option + breaks." },

    { id:"ni-rotorua-tepuia", title:"Rotorua: Te Puia guided experience (geothermal + culture)", region:"North Island trip", walk:"med", cost:120,
      tags:["culture","iconic"], transport:[LINKS.intercity],
      rating:4.6, ratingCount:273,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255111-d11453356-Te_Puia_Te_Ra_Guided_Experience-Rotorua_Rotorua_District_Bay_of_Plenty_Region_Nort.html",
      notes:"Guided route helps pacing. Build in seated breaks." },

    // Rotorua trout fishing
    { id:"fish-rotorua-trout-guide-list", title:"Rotorua trout fishing (guides/charters list) — choose low-wading option", region:"North Island trip", walk:"low", cost:450,
      tags:["trout","guided"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/Attractions-g255111-Activities-c61-t217-Rotorua_Rotorua_District_Bay_of_Plenty_Region_North_Island.html",
      notes:"Look for boat-based lake trout trips if knee mobility is limited." },

    // ----------------------------
    // Waikato & Taupo trout fishing
    // ----------------------------
    { id:"waikato-hamgardens", title:"Hamilton Gardens Highlights tour (gentle pace)", region:"Waikato (day trip)", walk:"low", cost:120,
      tags:["top-rated","beautiful"], transport:[LINKS.intercity],
      rating:4.9, ratingCount:48,
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g255108-d11473680-Hamilton_Gardens_Highlights_Tour-Hamilton_Waikato_Region_North_Island.html",
      notes:"One of the best ‘gentle’ day trips; big visual payoff." },

    { id:"taupo-trout-list", title:"Taupo trout fishing charters & guides (choose boat-based)", region:"Central Plateau (Taupo)", walk:"low", cost:450,
      tags:["trout","charter"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/Attractions-g255113-Activities-c61-t217-Taupo_Taupo_District_Waikato_Region_North_Island.html",
      notes:"Boat charters are very knee-friendly; confirm boarding accessibility." },

    { id:"taupo-lake-adventures", title:"Taupo: Lake trout fishing charter (Taupo Lake Adventures)", region:"Central Plateau (Taupo)", walk:"low", cost:400,
      tags:["trout","boat"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/Attraction_Review-g255113-d3292128-Reviews-Taupo_Lake_Adventures-Taupo_Taupo_District_Waikato_Region_North_Island.html",
      notes:"Good ‘all gear provided’ option; confirm trip length and seating." },

    // ----------------------------
    // Coromandel (knee-friendly boat option)
    // ----------------------------
    { id:"cor-cathedralcove-cruise", title:"Cathedral Cove: 2-hour Volcanic Coast cruise (seated boat)", region:"Coromandel (trip)", walk:"low", cost:155,
      tags:["iconic","knee-friendly"], transport:[LINKS.intercity],
      ratingUrl:"https://www.tripadvisor.co.nz/AttractionProductReview-g488373-d20482673-2_Hour_Cathedral_Cove_and_Volcanic_Coast_Cruise_with_Shade_Canopy-Whitianga_Coroma.html",
      notes:"Best Cathedral Cove experience for knee issues (boat instead of the track)." },

    // ----------------------------
    // Sports & venues (Auckland)
    // ----------------------------
    { id:"sports-eden-tour", title:"Eden Park: Stadium Tour (behind-the-scenes, short walking)", region:"Sports & venues", walk:"low", cost:35,
      tags:["venue","history"], transport:[LINKS.atPlanner, LINKS.edenTour],
      notes:"Great low-walking option; check tour times on the Eden Park site." },

    { id:"sports-eden-rooftop", title:"Eden Park: Rooftop Walk (views; check suitability)", region:"Sports & venues", walk:"med", cost:95,
      tags:["views","unique"], transport:[LINKS.atPlanner, LINKS.edenRooftop],
      notes:"Higher-mobility activity—review requirements and go with a guide." },

    { id:"sports-eden-events", title:"Attend a match/event at Eden Park (cricket/football) — pick a date", region:"Sports & venues", walk:"low", cost:30,
      tags:["cricket","football"], transport:[LINKS.atPlanner, LINKS.edenEvents],
      notes:"Use the Eden Park events calendar for January listings and tickets." },

    { id:"sports-auckland-fc", title:"Auckland FC home match (A-League / fixtures)", region:"Sports & venues", walk:"low", cost:30,
      tags:["football","tickets"], transport:[LINKS.atPlanner, LINKS.auckStadiumsAFC, LINKS.auckAFCMatches],
      notes:"Check fixture list for match dates/times and venue details." },

    // ----------------------------
    // South Island
    // ----------------------------
    { id:"si-nelson", title:"Nelson: waterfront + cafés (flat, relaxed, senior-friendly)", region:"South Island (flight)", walk:"low", cost:160,
      tags:["easy","sunny"], transport:[LINKS.airnz], notes:"Great 4–5 day side trip with minimal walking." },

    { id:"si-queenstown", title:"Queenstown: gondola / lake views (plan seated experiences)", region:"South Island (flight)", walk:"low", cost:220,
      tags:["iconic","scenic"], transport:[LINKS.airnz], notes:"Choose gondola + cruises and keep walks short/flat." },

    // Buffer
    { id:"buffer", title:"Rest / Buffer day (sleep-in, café, short flat outing)", region:"Free / low-cost", walk:"low", cost:0, free:true,
      tags:["recovery"], transport:[LINKS.atPlanner], notes:"Keep this day intentionally light." }
  ];

  // ---------- State ----------
  const LS_KEY = "nzTripPlanner_offline_v6_more_activities";
  const $ = (id)=>document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tz).toISOString().slice(0,10);
  }
  function uid(){ return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2))); }

  function mkItem(activityId, date, time){
    const a = ACTIVITIES.find(x=>x.id===activityId) || ACTIVITIES[0];
    return {
      id: uid(),
      date, time,
      activityId: a.id,
      region: a.region,
      walk: a.walk,
      cost: a.cost,
      transportLabel: a.transport?.[0]?.label || LINKS.atPlanner.label,
      transportUrl: a.transport?.[0]?.url || LINKS.atPlanner.url,
      rating: a.rating ?? null,
      ratingCount: a.ratingCount ?? null,
      ratingUrl: a.ratingUrl ?? "",
      notes: a.notes || ""
    };
  }

  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if (raw){ try { return JSON.parse(raw); } catch {} }

    const start = todayISO();
    return {
      startDate: start,
      budgetMode: "day",
      budgets: { day:180, week:900, total:3600 },
      walkFilter: "med",
      regionFilter: "All",
      ratingFilter: "off",
      timeRules: { dayStart:"10:00", slotMins:120, breakMins:45 },
      items: [
        mkItem("free-mt-eden", start, "10:00"),
        mkItem("auck-waterfront", start, "12:45"),
        mkItem("buffer", start, "15:30")
      ]
    };
  }

  let state = loadState();

// --- Normalize state so filters don't get stuck if options change between versions ---
function normalizeState(){
  const validBudgetMode = ["day","week","total"];
  const validWalk = ["any","low","med"];
  const validRating = ["off","46","48"];
  const validRegion = ["All","Auckland base","Hauraki Gulf islands","Bay of Islands","North Island trip","Coromandel (trip)","Waikato (day trip)","Central Plateau (Taupo)","Sports & venues","Free / low-cost","South Island (flight)"];

  if (!validBudgetMode.includes(state.budgetMode)) state.budgetMode = "day";
  if (!state.budgets || typeof state.budgets !== "object") state.budgets = { day:180, week:900, total:3600 };
  if (!validWalk.includes(state.walkFilter)) state.walkFilter = "med";
  if (!validRegion.includes(state.regionFilter)) state.regionFilter = "All";
  if (!validRating.includes(state.ratingFilter)) state.ratingFilter = "off";
  if (!state.timeRules || typeof state.timeRules !== "object") state.timeRules = { dayStart:"10:00", slotMins:120, breakMins:45 };

  state.items = Array.isArray(state.items) ? state.items : [];
  // Ensure each item has a valid activityId and derived fields
  state.items.forEach(it=>{
    if (!it.activityId || !ACTIVITIES.find(a=>a.id===it.activityId)) it.activityId = "buffer";
    applyActivityToItem(it, it.activityId);
    if (!it.date) it.date = todayISO();
    if (!it.time) it.time = state.timeRules.dayStart || "10:00";
  });
}

normalizeState();
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // ---------- Helpers ----------
  function money(n){ const v = Number(n); if (Number.isNaN(v)) return ""; return "NZ$" + v.toFixed(0); }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function walkPill(w){
    const cls = w==="low" ? "low" : (w==="med" ? "med" : "high");
    return `<span class="pill ${cls}">${(w||"low").toUpperCase()}</span>`;
  }
  function freePill(cost, freeFlag){
    if (freeFlag || Number(cost) === 0) return `<span class="pill free">FREE</span>`;
    return "";
  }

  function activeBudgetValue(){
    const m = state.budgetMode;
    if (m === "day") return Number(state.budgets.day || 0);
    if (m === "week") return Number(state.budgets.week || 0);
    return Number(state.budgets.total || 0);
  }
  function isOverBudget(cost){
    const b = activeBudgetValue();
    const c = Number(cost || 0);
    if (b <= 0) return false;
    return c > b;
  }
  function withinWalkFilter(w){
    const f = state.walkFilter;
    if (f==="any") return true;
    if (f==="low") return w==="low";
    if (f==="med") return (w==="low" || w==="med");
    return true;
  }
  function withinRegionFilter(region){
    const r = state.regionFilter;
    if (r==="All") return true;
    return region === r;
  }
  function withinRatingFilter(activity){
    const rf = state.ratingFilter;
    if (rf==="off") return true;
    const thr = (rf==="46") ? 4.6 : 4.8;
    if (activity.rating == null) return false;
    return Number(activity.rating) >= thr;
  }

  function parseTimeToMinutes(t){ const [hh, mm] = (t||"00:00").split(":").map(Number); return (hh*60 + mm); }
  function minutesToTime(mins){
    const m = ((mins % (24*60)) + (24*60)) % (24*60);
    const hh = String(Math.floor(m/60)).padStart(2,"0");
    const mm = String(Math.floor(m%60)).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function reflowDate(date){
    const startMin = parseTimeToMinutes(state.timeRules.dayStart || "10:00");
    const slot = Number(state.timeRules.slotMins || 120);
    const brk  = Number(state.timeRules.breakMins || 45);

    const dayIdxs = [];
    state.items.forEach((it, idx) => { if (it.date === date) dayIdxs.push(idx); });

    dayIdxs.forEach((arrayIdx, positionInDay) => {
      state.items[arrayIdx].time = minutesToTime(startMin + positionInDay * (slot + brk));
    });
  }

  function reflowAllDates(){
    const dates = [...new Set(state.items.map(x=>x.date))].sort();
    dates.forEach(reflowDate);
  }

  function computeTotals(){
    const total = state.items.reduce((acc,it)=>acc + (Number(it.cost)||0), 0);
    return { total };
  }

  function applyActivityToItem(item, activityId){
    const a = ACTIVITIES.find(x=>x.id===activityId);
    if (!a) return;
    item.activityId = a.id;
    item.region = a.region;
    item.walk = a.walk;
    item.cost = a.cost;
    item.transportLabel = a.transport?.[0]?.label || LINKS.atPlanner.label;
    item.transportUrl = a.transport?.[0]?.url || LINKS.atPlanner.url;
    item.rating = a.rating ?? null;
    item.ratingCount = a.ratingCount ?? null;
    item.ratingUrl = a.ratingUrl ?? "";
    item.notes = item.notes?.trim() ? item.notes : (a.notes || "");
  }

  // When date changes, move item into the correct date group in the array.
  function moveItemToDateGroupEnd(itemId, newDate){
    const idx = state.items.findIndex(x=>x.id===itemId);
    if (idx < 0) return;
    const item = state.items[idx];
    state.items.splice(idx, 1);
    let insertAt = state.items.length;
    for (let i = 0; i < state.items.length; i++){
      if (state.items[i].date === newDate) insertAt = i + 1;
    }
    state.items.splice(insertAt, 0, item);
  }

  // ---------- Render ----------
  function render(){
    // Controls
    $("budgetMode").value = state.budgetMode;
    $("budDay").value = state.budgets.day;
    $("budWeek").value = state.budgets.week;
    $("budTotal").value = state.budgets.total;
    $("walkFilter").value = state.walkFilter;
    $("regionFilter").value = state.regionFilter;
    $("ratingFilter").value = state.ratingFilter;
    $("dayStart").value = state.timeRules.dayStart;
    $("slotMins").value = state.timeRules.slotMins;
    $("breakMins").value = state.timeRules.breakMins;

    const totals = computeTotals();
    const bLabel = state.budgetMode === "day" ? "Daily" : (state.budgetMode==="week" ? "Weekly" : "Total");
    $("summary").textContent =
      `Items: ${state.items.length} • Est. spend: ${money(totals.total)} • ${bLabel} budget threshold: ${money(activeBudgetValue())} • Walk: ${state.walkFilter.toUpperCase()} • Region: ${state.regionFilter} • Rating filter: ${state.ratingFilter}`;

    const options = ACTIVITIES.map(a => {
      const ratingTxt = (a.rating != null) ? ` — ★${a.rating.toFixed(1)}` : "";
      const freeTxt = (a.free || Number(a.cost) === 0) ? " — FREE" : "";
      return `<option value="${a.id}">${escapeHtml(a.title + ratingTxt + freeTxt)}</option>`;
    }).join("");

    // Grouped itinerary render
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";

    const datesSorted = [...new Set(state.items.map(x=>x.date))].sort();
    datesSorted.forEach(date => {
      const hdr = document.createElement("tr");
      hdr.innerHTML = `<td colspan="9"><div class="dayHeader"><strong>${escapeHtml(date)}</strong> <span class="muted">— drag items within/onto this day</span></div></td>`;
      tbody.appendChild(hdr);

      state.items.filter(it => it.date === date).forEach(it => {
        const activity = ACTIVITIES.find(a=>a.id===it.activityId) || {};
        const over = isOverBudget(it.cost);
        const flight = (it.region || "").includes("(flight)");
        const ratingBadge = (it.rating != null)
          ? `<span class="pill star">★ ${Number(it.rating).toFixed(1)}/5${it.ratingCount ? ` (${it.ratingCount})` : ""}</span>`
          : `<span class="pill star">★ n/a</span>`;
        const ratingLink = it.ratingUrl ? `<a href="${it.ratingUrl}" target="_blank" rel="noreferrer">Reviews</a>` : "";

        const tr = document.createElement("tr");
        tr.dataset.id = it.id;
        tr.innerHTML = `
          <td><span class="dragHandle" title="Touch + drag to reorder">⠿</span></td>
          <td><input type="date" value="${it.date}" data-k="date" data-id="${it.id}"/></td>
          <td><input type="time" value="${it.time}" data-k="time" data-id="${it.id}"/></td>

          <td>
            <select data-k="activityId" data-id="${it.id}" style="width:100%">${options}</select>
            <div class="muted" style="margin-top:6px;">
              Notes:
              <input style="width:100%; margin-top:4px;" value="${escapeHtml(it.notes||"")}" data-k="notes" data-id="${it.id}"/>
            </div>
            <div>
              ${freePill(it.cost, activity.free)}
              ${over ? `<span class="pill warn">Over budget</span>` : ``}
              ${flight ? `<span class="pill flight">Flight likely</span>` : ``}
            </div>
          </td>

          <td>${escapeHtml(it.region || "")}</td>
          <td>${walkPill(it.walk || "low")}</td>
          <td><input type="number" min="0" step="5" value="${it.cost}" data-k="cost" data-id="${it.id}"/></td>

          <td>
            <div>${ratingBadge} ${ratingLink}</div>
            <div class="muted" style="margin-top:6px;">
              <a href="${it.transportUrl}" target="_blank" rel="noreferrer">${escapeHtml(it.transportLabel || "Transport")}</a>
            </div>
          </td>

          <td class="right"><button class="danger" data-action="del" data-id="${it.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
        tr.querySelector(`select[data-k="activityId"]`).value = it.activityId;
      });
    });

    
    // Mobile card rendering (phones)
    const cardsWrap = document.getElementById("itineraryCards");
    if (cardsWrap){
      const datesSorted2 = [...new Set(state.items.map(x=>x.date))].sort();
      const optionsHtml = options; // reuse activity options
      let cardsHtml = "";
      for (const date of datesSorted2){
        cardsHtml += `<div class="dayHeader"><strong>${escapeHtml(date)}</strong></div>`;
        const itemsForDate = state.items.filter(it => it.date === date);
        for (const it of itemsForDate){
          const a = ACTIVITIES.find(x=>x.id===it.activityId) || {};
          const over = isOverBudget(it.cost);
          const ratingBadge = (it.rating != null)
            ? `★ ${Number(it.rating).toFixed(1)}/5${it.ratingCount ? ` (${it.ratingCount})` : ""}`
            : `★ n/a`;
          cardsHtml += `
            <div class="itCard" data-id="${it.id}">
              <div class="itCardHeader">
                <div class="itCardTitle">${escapeHtml(a.title || "Activity")}</div>
                <button class="danger" data-action="del" data-id="${it.id}">Delete</button>
              </div>
              <div class="itCardMeta">
                ${walkPill(it.walk || "low")}
                <span class="pill">${escapeHtml(it.region || "")}</span>
                ${freePill(a)}
                ${over ? `<span class="pill warn">Over budget</span>` : ``}
                <span class="pill star">${escapeHtml(ratingBadge)}</span>
              </div>

              <div class="itCardGrid">
                <div class="field">
                  <label>Date</label>
                  <input type="date" value="${it.date}" data-k="date" data-id="${it.id}"/>
                </div>
                <div class="field">
                  <label>Time</label>
                  <input type="time" value="${it.time}" data-k="time" data-id="${it.id}"/>
                </div>
                <div class="field" style="grid-column:1 / -1;">
                  <label>Activity</label>
                  <select data-k="activityId" data-id="${it.id}">${optionsHtml}</select>
                </div>
                <div class="field">
                  <label>Cost (NZD)</label>
                  <input type="number" min="0" step="5" value="${it.cost}" data-k="cost" data-id="${it.id}"/>
                </div>
                <div class="field">
                  <label>Transport</label>
                  <a href="${it.transportUrl}" target="_blank" rel="noreferrer">${escapeHtml(it.transportLabel || "Transport")}</a>
                </div>
                <div class="field" style="grid-column:1 / -1;">
                  <label>Notes</label>
                  <input value="${escapeHtml(it.notes||"")}" data-k="notes" data-id="${it.id}"/>
                </div>
              </div>
            </div>
          `;
        }
      }
      cardsWrap.innerHTML = cardsHtml;
      // Set selected values for card selects
      cardsWrap.querySelectorAll('select[data-k="activityId"]').forEach(sel=>{
        const id = sel.dataset.id;
        const it = state.items.find(x=>x.id===id);
        if (it) sel.value = it.activityId;
      });
    }
// Suggestions
    const sWrap = document.getElementById("suggestions");
    const filtered = ACTIVITIES
      .filter(a => withinWalkFilter(a.walk))
      .filter(a => withinRegionFilter(a.region))
      .filter(a => withinRatingFilter(a));

    sWrap.innerHTML = filtered.map(a => {
      const over = isOverBudget(a.cost);
      const flight = (a.region || "").includes("(flight)");
      const tags = (a.tags || []).slice(0,5).map(t=>`<span class="pill tag">${escapeHtml(t)}</span>`).join("");
      const tLinks = (a.transport || []).map(t=>`<a href="${t.url}" target="_blank" rel="noreferrer">${escapeHtml(t.label)}</a>`).join(" • ");
      const ratingTxt = (a.rating != null) ? `★ ${a.rating.toFixed(1)}/5${a.ratingCount ? ` (${a.ratingCount})` : ""}` : "★ n/a";
      const ratingLink = a.ratingUrl ? ` • <a href="${a.ratingUrl}" target="_blank" rel="noreferrer">Reviews</a>` : "";

      return `
        <div class="notice" style="margin-top:10px;">
          <strong>${escapeHtml(a.title)}</strong>
          <div style="margin-top:6px;">
            ${walkPill(a.walk)}
            <span class="pill">${escapeHtml(a.region)}</span>
            <span class="pill">${money(a.cost)} est.</span>
            ${freePill(a.cost, a.free)}
            <span class="pill star">${ratingTxt}</span>${ratingLink}
            ${over ? `<span class="pill warn">Over budget</span>` : ``}
            ${flight ? `<span class="pill flight">Flight likely</span>` : ``}
          </div>
          <div class="muted" style="margin-top:8px;">${escapeHtml(a.notes || "")}</div>
          <div style="margin-top:6px;">${tags}</div>
          <div class="muted" style="margin-top:8px;">Transport: ${tLinks}</div>
          <div class="row" style="margin-top:10px;">
            <button data-action="addAct" data-act="${a.id}">Add</button>
            <button class="secondary" data-action="addActTomorrow" data-act="${a.id}">Add for tomorrow</button>
          </div>
        </div>
      `;
    }).join("") || `<div class="notice"><div class="muted">No options match your filters. Try lowering rating threshold or expanding filters.</div></div>`;

    wireTouchReorder();
    saveState();
  }

  // ---------- iPad touch reorder ----------
  let dragState = { active:false, dragId:null };

  function clearDropTargets(){
    document.querySelectorAll("tr.dropTarget").forEach(r=>r.classList.remove("dropTarget"));
    document.querySelectorAll("tr.dragging").forEach(r=>r.classList.remove("dragging"));
  }

  function rowFromPoint(x,y){
    const elAt = document.elementFromPoint(x,y);
    if (!elAt) return null;
    return elAt.closest("#tbl tbody tr[data-id]");
  }

  function wireTouchReorder(){
    document.querySelectorAll(".dragHandle").forEach(handle => {
      if (handle.dataset.bound === "1") return;
      handle.dataset.bound = "1";

      handle.addEventListener("pointerdown", (e) => {
        const tr = e.target.closest("tr[data-id]");
        if (!tr) return;
        e.preventDefault();
        handle.setPointerCapture(e.pointerId);
        dragState.active = true;
        dragState.dragId = tr.dataset.id;
        tr.classList.add("dragging");
      });

      handle.addEventListener("pointermove", (e) => {
        if (!dragState.active) return;
        const trTarget = rowFromPoint(e.clientX, e.clientY);
        clearDropTargets();
        const trDrag = document.querySelector(`#tbl tbody tr[data-id="${dragState.dragId}"]`);
        if (trDrag) trDrag.classList.add("dragging");
        if (trTarget && trTarget.dataset.id !== dragState.dragId) trTarget.classList.add("dropTarget");
      });

      handle.addEventListener("pointerup", (e) => {
        if (!dragState.active) return;
        dragState.active = false;

        const trTarget = rowFromPoint(e.clientX, e.clientY);
        if (!trTarget || trTarget.dataset.id === dragState.dragId){
          clearDropTargets();
          render();
          return;
        }

        const fromIdx = state.items.findIndex(x=>x.id===dragState.dragId);
        const toIdx   = state.items.findIndex(x=>x.id===trTarget.dataset.id);
        if (fromIdx < 0 || toIdx < 0){
          clearDropTargets();
          render();
          return;
        }

        const dragged = state.items[fromIdx];
        const target  = state.items[toIdx];
        const oldDate = dragged.date;
        const newDate = target.date;

        // reorder array
        state.items.splice(fromIdx, 1);
        const insertIdx = (fromIdx < toIdx) ? toIdx : toIdx;
        state.items.splice(insertIdx, 0, dragged);

        // adopt target date if different (drop onto another day header's items to move days)
        dragged.date = newDate;

        // reflow
        reflowDate(newDate);
        if (oldDate !== newDate) reflowDate(oldDate);

        clearDropTargets();
        render();
      });

      handle.addEventListener("pointercancel", () => {
        dragState.active = false;
        clearDropTargets();
        render();
      });
    });
  }

  // ---------- Actions ----------
  function addActivity(activityId, when="today"){
    const base = state.startDate || todayISO();
    const d = new Date(base + "T00:00:00");
    if (when==="tomorrow") d.setDate(d.getDate()+1);
    const tz = d.getTimezoneOffset() * 60000;
    const date = new Date(d.getTime()-tz).toISOString().slice(0,10);

    const it = mkItem(activityId, date, state.timeRules.dayStart || "10:00");
    state.items.push(it);
    moveItemToDateGroupEnd(it.id, date);
    reflowDate(date);
    render();
  }

  function resetAll(){
    localStorage.removeItem(LS_KEY);
    state = loadState();
    reflowAllDates();
    render();
  }

  // ---------- Import/Export ----------
  function showIO(mode){
    $("io").style.display = "block";
    $("ioText").value = mode==="export" ? JSON.stringify(state, null, 2) : "";
    $("ioApply").style.display = (mode==="import") ? "inline-block" : "none";
  }
  function hideIO(){ $("io").style.display = "none"; $("ioText").value = ""; }
  function applyImport(){
    try{
      const obj = JSON.parse($("ioText").value);
      obj.items = Array.isArray(obj.items) ? obj.items : [];
      obj.budgets = obj.budgets || { day:180, week:900, total:3600 };
      obj.walkFilter = obj.walkFilter || "med";
      obj.regionFilter = obj.regionFilter || "All";
      obj.ratingFilter = obj.ratingFilter || "off";
      obj.budgetMode = obj.budgetMode || "day";
      obj.timeRules = obj.timeRules || { dayStart:"10:00", slotMins:120, breakMins:45 };

      obj.items.forEach(it=>{
        const a = ACTIVITIES.find(x=>x.id===it.activityId) || ACTIVITIES[0];
        it.activityId = it.activityId || a.id;
        it.region = it.region || a.region;
        it.walk = it.walk || a.walk;
        it.cost = (it.cost ?? a.cost);
        it.transportLabel = it.transportLabel || (a.transport?.[0]?.label || LINKS.atPlanner.label);
        it.transportUrl = it.transportUrl || (a.transport?.[0]?.url || LINKS.atPlanner.url);
        it.rating = (it.rating ?? a.rating ?? null);
        it.ratingCount = (it.ratingCount ?? a.ratingCount ?? null);
        it.ratingUrl = (it.ratingUrl ?? a.ratingUrl ?? "");
        it.notes = it.notes ?? a.notes ?? "";
      });

      state = obj;
      hideIO();
      reflowAllDates();
      render();
    } catch (e){
      alert("Import failed: " + e.message);
    }
  }

  // ---------- Events ----------
  $("budgetMode").addEventListener("change",(e)=>{ state.budgetMode = e.target.value; render(); });
  $("walkFilter").addEventListener("change",(e)=>{ state.walkFilter = e.target.value; render(); });
  $("regionFilter").addEventListener("change",(e)=>{ state.regionFilter = e.target.value; render(); });
  $("ratingFilter").addEventListener("change",(e)=>{ state.ratingFilter = e.target.value; render(); });

  ["budDay","budWeek","budTotal"].forEach(id=>{
    $(id).addEventListener("input",(e)=>{
      const v = Number(e.target.value || 0);
      if (id==="budDay") state.budgets.day = v;
      if (id==="budWeek") state.budgets.week = v;
      if (id==="budTotal") state.budgets.total = v;
      render();
    });
  });

  ["dayStart","slotMins","breakMins"].forEach(id=>{
    $(id).addEventListener("input",(e)=>{
      if (id==="dayStart") state.timeRules.dayStart = e.target.value || "10:00";
      if (id==="slotMins") state.timeRules.slotMins = Number(e.target.value || 120);
      if (id==="breakMins") state.timeRules.breakMins = Number(e.target.value || 45);
      reflowAllDates();
      render();
    });
  });

  $("addSuggested").addEventListener("click", ()=>{
    const first = ACTIVITIES.find(a => withinWalkFilter(a.walk) && withinRegionFilter(a.region) && withinRatingFilter(a)) || ACTIVITIES[0];
    if (first) addActivity(first.id, "today");
  });

  $("addBuffer").addEventListener("click", ()=>addActivity("buffer","today"));
  $("reflowAll").addEventListener("click", ()=>{ reflowAllDates(); render(); });

  $("reset").addEventListener("click", resetAll);
  $("exportJson").addEventListener("click", ()=>showIO("export"));
  $("importJson").addEventListener("click", ()=>showIO("import"));
  $("ioClose").addEventListener("click", hideIO);
  $("ioApply").addEventListener("click", applyImport);

  // Delegated clicks
  document.body.addEventListener("click",(e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const action = btn.dataset.action;

    if (action==="del"){
      const id = btn.dataset.id;
      const it = state.items.find(x=>x.id===id);
      const date = it?.date;
      state.items = state.items.filter(x=>x.id !== id);
      if (date) reflowDate(date);
      render();
      return;
    }
    if (action==="addAct"){ addActivity(btn.dataset.act, "today"); return; }
    if (action==="addActTomorrow"){ addActivity(btn.dataset.act, "tomorrow"); return; }
  });

  // Delegated inputs
  document.body.addEventListener("input",(e)=>{
    const t = e.target;
    const id = t.dataset.id;
    const k = t.dataset.k;
    if (!id || !k) return;

    const it = state.items.find(x=>x.id===id);
    if (!it) return;

    if (k==="activityId"){
      applyActivityToItem(it, t.value);
      reflowDate(it.date);
      render();
      return;
    }

    if (k==="cost"){ it[k] = Number(t.value || 0); render(); return; }
    if (k==="notes"){ it[k] = t.value; render(); return; }
    if (k==="time"){ it[k] = t.value; render(); return; }

    if (k==="date"){
      const oldDate = it.date;
      const newDate = t.value;
      if (!newDate){ render(); return; }

      it.date = newDate;
      moveItemToDateGroupEnd(it.id, newDate);
      reflowDate(oldDate);
      reflowDate(newDate);
      render();
      return;
    }

    render();
  });

  // ---------- Init ----------
  reflowAllDates();
  render();
</script>
</body>
</html>
